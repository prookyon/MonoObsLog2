# Technical Documentation for AI Assistants

## Architecture Overview

**Pattern**: MVC-like with centralized database access
- [`MainWindow`](src/mainwindow.cpp:17) - Main controller, manages tab lifecycle
- [`DatabaseManager`](src/databasemanager.cpp:7) - Singleton-style database accessor
- Tab classes - Individual controllers for each tab's UI and logic
- `.ui` files - Qt Designer XML for visual layouts

## File Structure

```
include/*.h          - Header files (class declarations)
src/*.cpp            - Implementation files
uifiles/*.ui         - Qt Designer UI files (XML)
build/               - Generated: moc_*, ui_*, compiled objects
```

## Key Conventions

### Naming
- Tab classes: `{Name}Tab` (e.g., [`ObjectsTab`](include/objectstab.h:12))
- UI files: `{name}tab.ui` (lowercase)
- Generated: `ui_{name}tab.h` (auto-generated by Qt's UIC)

### Qt Patterns
- All QObject-derived classes use `Q_OBJECT` macro for signal/slot support
- UI members accessed via `ui->widgetName`
- Parent-child memory management (parent owns children)
- Use `std::unique_ptr` for owned objects without Qt parent

### Tab Class Structure
```cpp
class TabName : public QWidget {
    Q_OBJECT
public:
    explicit TabName(DatabaseManager* dbManager, QWidget *parent = nullptr);
    ~TabName();
    void initialize();    // Called once after construction
    void refreshData();   // Called to reload from database
private:
    Ui::TabName *ui;           // Generated from .ui file
    DatabaseManager* m_dbManager;  // Non-owning pointer
};
```

## Database Schema

**Creation Order** (due to foreign keys):
1. `filter_types` (no dependencies)
2. `cameras`, `telescopes`, `objects`, `sessions` (independent)
3. `filters` (depends on `filter_types`)
4. `observations` (depends on all above)

**Key Relationships**:
- `filters.filter_type_id` â†’ `filter_types.id`
- `observations` links to: sessions, objects, cameras, telescopes, filters

**Database File**: `mgw_observations.db` (SQLite3)

## Implementation Guide

### Adding New Tab Functionality

1. **Edit UI**: Modify `uifiles/{tab}tab.ui` with Qt Designer
2. **Implement Logic**: Add to `src/{tab}tab.cpp`:
   ```cpp
   void TabName::initialize() {
       // Setup UI state, connect signals
       connect(ui->button, &QPushButton::clicked, this, &TabName::onButtonClick);
       refreshData();
   }
   
   void TabName::refreshData() {
       QSqlQuery query(m_dbManager->database());
       query.exec("SELECT * FROM table");
       // Populate UI with results
   }
   ```

### CRUD Operations Pattern (see [`ObjectsTab`](src/objectstab.cpp:1))

**UI Layout**: QTableWidget + Add/Edit/Delete buttons
- Hide ID column, store in Qt::UserRole: `item->setData(Qt::UserRole, id)`
- Retrieve ID: `item->data(Qt::UserRole).toInt()`

**Custom Dialog**: Create helper method for unified Add/Edit form
```cpp
bool showObjectDialog(QString &name, QString &field1, QString &field2) {
   QDialog dialog(this);
   QFormLayout *layout = new QFormLayout(&dialog);
   // Add QLineEdit fields for each property
   // Return true if OK clicked, false if cancelled
}
```

**Operations**:
- **Add**: Show dialog, INSERT with parameterized query, `refreshData()`
- **Edit**: Get selected row ID, pre-fill dialog, UPDATE, `refreshData()`
- **Delete**: Show `QMessageBox::question()` confirmation, DELETE, `refreshData()`
- No success popups (silent operations), show errors only

### Database Operations

```cpp
// Access database through manager
QSqlDatabase& db = m_dbManager->database();
QSqlQuery query(db);

// Parameterized queries (prevent SQL injection)
query.prepare("INSERT INTO table (col) VALUES (:value)");
query.bindValue(":value", data);
query.exec();

// Error handling
if (!query.exec()) {
    qDebug() << "Error:" << query.lastError().text();
}
```

### Signal/Slot Pattern

```cpp
// In header
signals:
    void dataChanged();
    
private slots:
    void onButtonClicked();

// In implementation
connect(ui->button, &QPushButton::clicked, this, &ClassName::onButtonClicked);
emit dataChanged();  // Notify listeners
```

## Build System

**CMake Configuration**:
- [`CMakeLists.txt`](CMakeLists.txt:1) - Auto-configured for Qt6
- `CMAKE_AUTOMOC=ON` - Automatic MOC (Meta-Object Compiler)
- `CMAKE_AUTOUIC=ON` - Automatic UIC (UI Compiler)
- `CMAKE_AUTOUIC_SEARCH_PATHS=uifiles` - UI file location

**Build Process**:
1. UIC generates `ui_*.h` from `.ui` files
2. MOC generates `moc_*.cpp` from Q_OBJECT classes
3. Compiler builds all `.cpp` and `moc_*.cpp`
4. Linker creates executable with Qt libraries

## Common Tasks

### Add UI Widget
1. Open `.ui` file in Qt Designer
2. Drag widget, set objectName property
3. Access in code: `ui->objectName`

### Add Database Table
1. Add CREATE TABLE to [`DatabaseManager::createTables()`](src/databasemanager.cpp:49)
2. Maintain foreign key order
3. Consider adding to `.gitignore` for `.db` files

### Add New Tab
1. Create files: `include/{name}tab.h`, `src/{name}tab.cpp`, `uifiles/{name}tab.ui`
2. Add to [`CMakeLists.txt`](CMakeLists.txt:16) (3 lists: SOURCES, HEADERS, UI)
3. Add to [`MainWindow`](include/mainwindow.h:24): member + initialization
4. Add tab to [`uifiles/mainwindow.ui`](uifiles/mainwindow.ui:19)

## Important Notes

- **Memory**: Qt parent-child manages most memory; use smart pointers for non-Qt objects
- **Database**: Single QSqlDatabase instance shared via [`DatabaseManager`](include/databasemanager.h:8)
- **Thread Safety**: Current design is single-threaded (UI thread only)
- **UI Files**: Never edit `ui_*.h` directly (regenerated on build)
- **Signals/Slots**: Prefer new syntax: `&Class::method` over `SIGNAL()` macro

## Debugging

```cpp
#include <QDebug>
qDebug() << "Variable:" << value;

// SQL debugging
query.exec();
qDebug() << query.executedQuery();
qDebug() << query.lastError().text();
```

## Dependencies

- Qt6Core - Core functionality
- Qt6Widgets - GUI components  
- Qt6Sql - Database (includes SQLite driver)
- Standard C++17 - smart pointers, std::make_unique

## Generated Files (Do Not Edit)

- `build/mgwObsLog_autogen/` - MOC and UIC output
- `build/mgwObsLog_autogen/include/ui_*.h` - UI class definitions
- `build/mgwObsLog_autogen/*/moc_*.cpp` - Meta-object code